<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ABC-XYZ –ê–Ω–∞–ª–∏–∑</title>
</head>
<body>
    <h1>ABC-XYZ –ê–Ω–∞–ª–∏–∑</h1>

    <h2>1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel-—Ñ–∞–π–ª</h2>
    <form id="uploadForm">
        <input type="file" name="file" required />
        <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </form>

    <h2>2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑</h2>
    <button id="analyzeBtn" onclick="startAnalysis()" disabled>–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>

    <p id="status"></p>
    <div id="download"></div>
    

    <script>
    let currentTaskId = null;
    let checkInterval = null;
    let uploadedFileName = null;

    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const response = await fetch("/upload", {
        method: "POST",
        body: formData
        });
        const result = await response.json();
        alert(result.message);
        uploadedFileName = result.filename;
        document.getElementById("analyzeBtn").disabled = false;
    });

    async function startAnalysis() {
        if (!uploadedFileName) {
            alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ Excel-—Ñ–∞–π–ª üìÑ");
            return;
        }

        document.getElementById("status").innerText = "–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω ‚è≥";
        document.getElementById("download").innerHTML = "";

        let response = await fetch("/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ filename: uploadedFileName })
        });

        let data = await response.json();
        currentTaskId = data.task_id;
        checkInterval = setInterval(checkStatus, 2000);
    }


    async function checkStatus() {
        let response = await fetch(`/status/${currentTaskId}`);
        let data = await response.json();

        if (data.ready) {
        clearInterval(checkInterval);
        document.getElementById("status").innerText = "–ì–æ—Ç–æ–≤–æ ‚úÖ";
        document.getElementById("download").innerHTML =
            `<a href="/download/${currentTaskId}" download>
            üì• –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç (Excel)
            </a><br>
            <img src="/chart/${currentTaskId}" alt="–î–∏–∞–≥—Ä–∞–º–º–∞ ABC-XYZ" style="margin-top:10px; max-width:500px;">`;
        } else if (data.error) {
        document.getElementById("status").innerText = "–û—à–∏–±–∫–∞ ‚ùå";
        console.error(data.error);
        }
    }
    </script>

</body>
</html>


